<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kiosco Maquipan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <div id="login-screen" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card shadow p-4" style="max-width: 400px; width: 100%;">
            <div class="text-center mb-3"><i class="fas fa-chart-pie fa-3x text-primary"></i></div>
            <h4 class="text-center mb-3">Panel de Control</h4>
            <form id="admin-login-form">
                <input type="email" id="admin-user" class="form-control mb-2" placeholder="admin@maquipan.cl" required>
                <input type="password" id="admin-pass" class="form-control mb-3" placeholder="Contraseña" required>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Entrar</button>
            </form>
            <div id="error-msg" class="alert alert-danger mt-3 d-none text-center small"></div>
        </div>
    </div>

    <div id="dashboard-screen" class="d-none">
        <nav class="navbar navbar-dark bg-dark mb-4 sticky-top shadow">
            <div class="container">
                <a class="navbar-brand fw-bold text-warning" href="#"><i class="fas fa-box-open"></i> Gestión Maquipan</a>
                <div class="d-flex align-items-center">
                    <button onclick="window.logout()" class="btn btn-outline-danger btn-sm me-2">Salir</button>
                    <a href="index.html" class="btn btn-outline-light btn-sm" target="_blank">Ver Kiosco</a>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <div class="row mb-4 g-3">
                <div class="col-md-4"><div class="card text-white bg-success h-100 shadow-sm"><div class="card-body"><h6>Valor Inventario</h6><h3 class="fw-bold" id="kpi-valor">$0</h3></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-danger h-100 shadow-sm"><div class="card-body"><h6>Stock Crítico</h6><h3 class="fw-bold" id="kpi-critico">0</h3></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-info h-100 shadow-sm"><div class="card-body"><h6>Ventas Totales</h6><h3 class="fw-bold" id="kpi-ventas">$0</h3></div></div></div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-dark text-white fw-bold">Nuevo Producto</div>
                        <div class="card-body">
                            <form id="product-form">
                                <input type="hidden" id="edit-id">
                                <div class="mb-2"><input type="text" id="nombre" class="form-control" placeholder="Nombre" required></div>
                                <div class="mb-2">
                                    <select id="categoria" class="form-select" required>
                                        <option value="" disabled selected>Categoría...</option>
                                        <option value="Bebidas">Bebidas</option>
                                        <option value="Snacks">Snacks</option>
                                        <option value="Cafeteria">Cafetería</option>
                                        <option value="Otros">Otros</option>
                                    </select>
                                </div>
                                <div class="mb-2"><input type="text" id="mejoras" class="form-control form-control-sm" placeholder="Detalle (ej: Sin azúcar)"></div>
                                <div class="row g-2 mb-2">
                                    <div class="col-6"><input type="number" id="precio" class="form-control" placeholder="Precio" required></div>
                                    <div class="col-6"><input type="number" id="stock" class="form-control" placeholder="Stock" required></div>
                                </div>
                                <div class="mb-3"><input type="url" id="img" class="form-control" placeholder="URL Imagen" required></div>
                                <button type="submit" class="btn btn-primary w-100 fw-bold" id="btn-save">Guardar</button>
                                <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="btn-cancel" onclick="resetForm()">Cancelar</button>
                            </form>
                            <hr>
                            <h6 class="fw-bold text-muted mt-3">Registrar Compañero</h6>
                            <form id="create-client-form" class="row g-2">
                                <div class="col-12"><input type="text" id="new-name" class="form-control form-control-sm" placeholder="Nombre" required></div>
                                <div class="col-6"><input type="email" id="new-email" class="form-control form-control-sm" placeholder="Email" required></div>
                                <div class="col-6"><input type="text" id="new-pass" class="form-control form-control-sm" placeholder="Clave" required></div>
                                <div class="col-12"><button type="submit" class="btn btn-sm btn-outline-success w-100">Crear</button></div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Inventario</span>
                            <span class="badge bg-secondary" id="total-items-count">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="height: 500px; overflow: auto;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light sticky-top"><tr><th>Img</th><th>Producto</th><th>Cat.</th><th>Stock</th><th>Acción</th></tr></thead>
                                    <tbody id="products-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white py-3">
                            <div class="row align-items-center">
                                <div class="col-md-6"><h5 class="mb-0 fw-bold text-primary">Historial Ventas</h5></div>
                                <div class="col-md-6"><input type="text" id="search-sales" class="form-control" placeholder="Buscar venta..."></div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="height: 400px; overflow: auto;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light sticky-top"><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th class="text-end">Total</th><th class="text-end">Acciones</th></tr></thead>
                                    <tbody id="sales-table"><tr><td colspan="5" class="text-center py-3">Cargando...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm border-info h-100">
                        <div class="card-header bg-info text-white fw-bold">
                            <i class="fas fa-lightbulb"></i> Buzón de Sugerencias
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="height: 400px; overflow: auto;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Sugerencia</th>
                                            <th class="text-end">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="suggestions-table">
                                        <tr><td colspan="2" class="text-center py-3 text-muted">No hay sugerencias nuevas.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="editSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold">Corregir Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-sale-form">
                        <input type="hidden" id="sale-id">
                        <div class="mb-3"><label>Cliente</label><input type="text" id="sale-client" class="form-control"></div>
                        <div class="mb-3"><label>Total ($)</label><input type="number" id="sale-total" class="form-control fw-bold"></div>
                        <p class="text-muted small">Nota: Editar aquí solo cambia el texto, no el stock.</p>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="window.guardarVentaEditada()">Guardar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, getDoc, writeBatch, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLPcKBki7SgEDqGoU2zGmvynmdRIaqYOA",
            authDomain: "negocio-30867.firebaseapp.com",
            projectId: "negocio-30867",
            storageBucket: "negocio-30867.firebasestorage.app",
            messagingSenderId: "164146774814",
            appId: "1:164146774814:web:19aba62c4a8314ad873f0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const ADMIN_EMAILS = ["cpimentel@maquipan.cl", "admin@maquipan.cl"];
        const clp = new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP'});
        let inventario = [], historialVentas = [];

        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('admin-user').value, document.getElementById('admin-pass').value); } 
            catch(e) { document.getElementById('error-msg').classList.remove('d-none'); document.getElementById('error-msg').innerText = "Credenciales incorrectas"; }
        });
        window.logout = () => signOut(auth).then(()=>location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('dashboard-screen').classList.remove('d-none');
                initApp();
            } else if (user) { alert("Sin permisos"); signOut(auth); }
        });

        function initApp() {
            // 1. PRODUCTOS
            onSnapshot(collection(db, "productos"), (snap) => {
                inventario = [];
                let valor=0, criticos=0;
                const tbody = document.getElementById('products-table'); tbody.innerHTML = '';
                snap.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    inventario.push(p);
                    valor += (p.precio * p.stock);
                    if(p.stock < 5) criticos++;
                    tbody.innerHTML += `
                        <tr class="${p.stock<5?'table-danger':''}">
                            <td><img src="${p.img}" width="30"></td>
                            <td>${p.nombre}<br><small class="text-muted">${p.mejoras||''}</small></td>
                            <td><span class="badge bg-secondary">${p.categoria||'-'}</span></td>
                            <td class="fw-bold">${p.stock}</td>
                            <td>
                                <button class="btn btn-sm btn-primary py-0" onclick="window.editar('${p.id}')"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-sm btn-danger py-0" onclick="window.borrar('${p.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
                document.getElementById('kpi-valor').innerText = clp.format(valor);
                document.getElementById('kpi-critico').innerText = criticos;
                document.getElementById('total-items-count').innerText = inventario.length;
            });

            // 2. VENTAS
            onSnapshot(query(collection(db, "ventas"), orderBy("fecha", "desc")), (snap) => {
                historialVentas = [];
                let totalH=0;
                snap.forEach(d => { const v={id:d.id, ...d.data()}; historialVentas.push(v); totalH+=(v.total||0); });
                document.getElementById('kpi-ventas').innerText = clp.format(totalH);
                renderVentas(historialVentas);
            });

            // 3. SUGERENCIAS (NUEVO)
            onSnapshot(query(collection(db, "sugerencias"), orderBy("fecha", "desc")), (snap) => {
                const tbody = document.getElementById('suggestions-table');
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="2" class="text-center py-3 text-muted">Sin novedades.</td></tr>'; return; }
                
                tbody.innerHTML = '';
                snap.forEach(d => {
                    const s = {id:d.id, ...d.data()};
                    const fecha = s.fecha ? s.fecha.toDate().toLocaleDateString() : '-';
                    tbody.innerHTML += `
                        <tr>
                            <td>
                                <div class="fw-bold text-dark">${s.producto}</div>
                                <div class="small text-muted">De: ${s.usuario} (${fecha})</div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="window.borrarSugerencia('${s.id}')" title="Borrar"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>`;
                });
            });
        }

        function renderVentas(lista) {
            const tbody = document.getElementById('sales-table');
            tbody.innerHTML = '';
            lista.forEach(v => {
                const items = v.detalle ? v.detalle.map(i=>`${i.cantidad}x${i.nombre}`).join(', ') : '';
                const fecha = v.fecha ? v.fecha.toDate().toLocaleDateString() : '-';
                tbody.innerHTML += `<tr><td class="small">${fecha}</td><td>${v.usuario}<br><small>${v.email}</small></td><td class="small text-muted">${items}</td><td class="text-end fw-bold text-success">${clp.format(v.total)}</td><td class="text-end"><button class="btn btn-sm btn-light border" onclick="window.prepEdit('${v.id}')"><i class="fas fa-pen text-warning"></i></button><button class="btn btn-sm btn-light border ms-1" onclick="window.borrarVenta('${v.id}')"><i class="fas fa-trash text-danger"></i></button></td></tr>`;
            });
        }

        // --- BORRAR SUGERENCIA ---
        window.borrarSugerencia = async (id) => {
            if(confirm("¿Borrar esta sugerencia?")) await deleteDoc(doc(db, "sugerencias", id));
        };

        // --- LÓGICA DE BORRADO DE VENTA CON DEVOLUCIÓN DE STOCK ---
        window.borrarVenta = async (id) => {
            if(!confirm("¿Eliminar venta y DEVOLVER STOCK?")) return;
            try {
                const ventaRef = doc(db, "ventas", id);
                const ventaSnap = await getDoc(ventaRef);
                if (!ventaSnap.exists()) return alert("Error: No existe.");
                
                const ventaData = ventaSnap.data();
                const batch = writeBatch(db);

                if (ventaData.detalle) {
                    ventaData.detalle.forEach(item => {
                        const prodRef = doc(db, "productos", item.id);
                        batch.update(prodRef, { stock: increment(item.cantidad) });
                    });
                }
                batch.delete(ventaRef);
                await batch.commit();
                alert("Venta eliminada y stock restaurado.");
            } catch (error) { alert("Error: " + error.message); }
        };

        // CRUD PRODUCTOS
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                mejoras: document.getElementById('mejoras').value,
                precio: Number(document.getElementById('precio').value),
                stock: Number(document.getElementById('stock').value),
                img: document.getElementById('img').value
            };
            if(id) await updateDoc(doc(db, "productos", id), data);
            else await addDoc(collection(db, "productos"), data);
            resetForm();
        });

        window.editar = (id) => {
            const p = inventario.find(x => x.id === id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('nombre').value = p.nombre;
            document.getElementById('categoria').value = p.categoria || "";
            document.getElementById('mejoras').value = p.mejoras || "";
            document.getElementById('precio').value = p.precio;
            document.getElementById('stock').value = p.stock;
            document.getElementById('img').value = p.img;
            document.getElementById('btn-save').innerText = "Actualizar";
            document.getElementById('btn-cancel').classList.remove('d-none');
        };

        window.resetForm = () => {
            document.getElementById('product-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('btn-save').innerText = "Guardar";
            document.getElementById('btn-cancel').classList.add('d-none');
        };

        window.borrar = async(id) => { if(confirm("¿Borrar producto?")) await deleteDoc(doc(db, "productos", id)); };
        
        // VENTAS Y CLIENTES
        document.getElementById('search-sales').addEventListener('input', (e) => {
            const t = e.target.value.toLowerCase();
            const f = historialVentas.filter(v => (v.usuario||"").toLowerCase().includes(t) || JSON.stringify(v.detalle).toLowerCase().includes(t));
            renderVentas(f);
        });

        window.prepEdit = (id) => {
            const v = historialVentas.find(x => x.id === id);
            document.getElementById('sale-id').value = v.id;
            document.getElementById('sale-client').value = v.usuario;
            document.getElementById('sale-total').value = v.total;
            new bootstrap.Modal(document.getElementById('editSaleModal')).show();
        };

        window.guardarVentaEditada = async () => {
            await updateDoc(doc(db, "ventas", document.getElementById('sale-id').value), {
                usuario: document.getElementById('sale-client').value,
                total: Number(document.getElementById('sale-total').value)
            });
            bootstrap.Modal.getInstance(document.getElementById('editSaleModal')).hide();
        };

        document.getElementById('create-client-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const c = await createUserWithEmailAndPassword(secondaryAuth, document.getElementById('new-email').value, document.getElementById('new-pass').value);
                await updateProfile(c.user, { displayName: document.getElementById('new-name').value });
                await signOut(secondaryAuth); alert("Cliente creado"); document.getElementById('create-client-form').reset();
            } catch(e) { alert(e.message); }
        });
    </script>
</body>
</html>
