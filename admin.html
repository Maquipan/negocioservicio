<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Finanzas Maquipan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <div id="login-screen" class="container d-flex justify-content-center align-items-center vh-100">
        <div class="card shadow p-4" style="max-width: 400px; width: 100%;">
            <div class="text-center mb-3"><i class="fas fa-user-shield fa-3x text-primary"></i></div>
            <h4 class="text-center mb-3">Acceso Admin</h4>
            <form id="admin-login-form">
                <input type="email" id="admin-user" class="form-control mb-2" placeholder="admin@maquipan.cl" required>
                <input type="password" id="admin-pass" class="form-control mb-3" placeholder="Contraseña" required>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Entrar</button>
            </form>
            <div id="error-msg" class="alert alert-danger mt-3 d-none text-center small"></div>
        </div>
    </div>

    <div id="dashboard-screen" class="d-none">
        <nav class="navbar navbar-dark bg-dark mb-4 sticky-top shadow">
            <div class="container">
                <a class="navbar-brand fw-bold text-warning" href="#"><i class="fas fa-coins"></i> Finanzas Maquipan</a>
                <div class="d-flex align-items-center">
                    <span id="admin-name-display" class="text-white me-3 small d-none d-md-inline"></span>
                    <button onclick="window.logout()" class="btn btn-outline-danger btn-sm me-2">Salir</button>
                    <a href="index.html" class="btn btn-outline-light btn-sm" target="_blank">Ver Kiosco</a>
                </div>
            </div>
        </nav>

        <div class="container pb-5">
            <div class="row mb-4 g-3">
                <div class="col-md-4"><div class="card text-white bg-success h-100 shadow-sm"><div class="card-body"><h6>Dinero Recaudado (Pagado)</h6><h3 class="fw-bold" id="kpi-pagado">$0</h3></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-danger h-100 shadow-sm"><div class="card-body"><h6>Por Cobrar (Fiado)</h6><h3 class="fw-bold" id="kpi-pendiente">$0</h3></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-info h-100 shadow-sm"><div class="card-body"><h6>Valor Inventario</h6><h3 class="fw-bold" id="kpi-valor">$0</h3></div></div></div>
            </div>

            <div class="card shadow-sm border-warning mb-4">
                <div class="card-header bg-warning text-dark fw-bold"><i class="fas fa-cash-register"></i> Venta Manual (Oficina)</div>
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="small text-muted">Producto</label>
                            <select id="manual-product-select" class="form-select"><option value="">Cargando productos...</option></select>
                        </div>
                        <div class="col-md-2"><label class="small text-muted">Cant</label><input type="number" id="manual-qty" class="form-control" value="1" min="1"></div>
                        <div class="col-md-2"><button class="btn btn-dark w-100" onclick="window.agregarAlTicketManual()"><i class="fas fa-plus"></i></button></div>
                        <div class="col-md-4"><label class="small text-muted">Cliente</label><input type="text" id="manual-client-name" class="form-control" placeholder="Nombre compañero"></div>
                    </div>
                    <div class="table-responsive mt-3 border rounded">
                        <table class="table table-sm table-striped mb-0"><thead class="table-light"><tr><th>Producto</th><th class="text-center">Cant.</th><th class="text-end">Subtotal</th><th></th></tr></thead><tbody id="manual-cart-items"><tr><td colspan="4" class="text-center text-muted small py-2">Ticket vacío</td></tr></tbody></table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3 bg-light p-3 rounded">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="check-pagado" checked>
                            <label class="form-check-label fw-bold" for="check-pagado">¿Pagado ahora?</label>
                        </div>
                        <div class="d-flex align-items-center">
                            <h4 class="mb-0 me-3">Total: <span id="manual-total" class="text-success fw-bold">$0</span></h4>
                            <button class="btn btn-success fw-bold" onclick="window.confirmarVentaManual()">Confirmar Venta</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6"><h5 class="mb-0 fw-bold text-primary">Historial y Cobranza</h5></div>
                        <div class="col-md-6"><input type="text" id="search-sales" class="form-control" placeholder="Buscar por cliente..."></div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="height: 400px; overflow: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light sticky-top"><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th class="text-end">Total</th><th class="text-center">Estado</th><th class="text-end">Acciones</th></tr></thead>
                            <tbody id="sales-table"><tr><td colspan="6" class="text-center py-3">Cargando ventas...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion mb-4" id="accordionProd">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed fw-bold bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProd">
                            <i class="fas fa-boxes me-2"></i> Gestión de Inventario 
                            <span id="total-items-count" class="badge bg-secondary ms-2">0</span>
                        </button>
                    </h2>
                    <div id="collapseProd" class="accordion-collapse collapse show" data-bs-parent="#accordionProd">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-0 bg-light mb-3">
                                        <div class="card-body">
                                            <h6 class="fw-bold">Editar / Crear</h6>
                                            <form id="product-form">
                                                <input type="hidden" id="edit-id">
                                                <input type="text" id="nombre" class="form-control mb-2" placeholder="Nombre" required>
                                                <select id="categoria" class="form-select mb-2" required>
                                                    <option value="" disabled selected>Categoría...</option>
                                                    <option value="Bebidas">Bebidas</option>
                                                    <option value="Snacks">Snacks</option>
                                                    <option value="Cafeteria">Cafetería</option>
                                                    <option value="Otros">Otros</option>
                                                </select>
                                                <input type="text" id="mejoras" class="form-control mb-2" placeholder="Detalle">
                                                <div class="row g-2 mb-2"><div class="col"><input type="number" id="precio" class="form-control" placeholder="$" required></div><div class="col"><input type="number" id="stock" class="form-control" placeholder="Cant" required></div></div>
                                                <input type="url" id="img" class="form-control mb-2" placeholder="URL Imagen" required>
                                                <button type="submit" class="btn btn-dark w-100" id="btn-save">Guardar</button>
                                                <button type="button" class="btn btn-secondary w-100 mt-2 d-none" id="btn-cancel" onclick="resetForm()">Cancelar</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="table-responsive" style="height: 400px; overflow: auto;">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead class="table-light sticky-top"><tr><th>Producto</th><th>Cat.</th><th>Stock</th><th>Precio</th><th>Acciones</th></tr></thead>
                                            <tbody id="products-table"><tr><td colspan="5" class="text-center py-3">Cargando productos...</td></tr></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="editSaleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold">Editar Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-sale-form">
                        <input type="hidden" id="sale-id">
                        <div class="mb-3"><label>Cliente</label><input type="text" id="sale-client" class="form-control"></div>
                        <div class="mb-3"><label>Total ($)</label><input type="number" id="sale-total" class="form-control fw-bold"></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-primary" onclick="window.guardarVentaEditada()">Guardar Cambios</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, getDoc, writeBatch, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLPcKBki7SgEDqGoU2zGmvynmdRIaqYOA",
            authDomain: "negocio-30867.firebaseapp.com",
            projectId: "negocio-30867",
            storageBucket: "negocio-30867.firebasestorage.app",
            messagingSenderId: "164146774814",
            appId: "1:164146774814:web:19aba62c4a8314ad873f0f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- IMPORTANTE: VERIFICA QUE TU CORREO ESTÉ AQUÍ ---
        const ADMIN_EMAILS = ["cpimentel@maquipan.cl", "admin@maquipan.cl"];
        
        const clp = new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP'});
        let inventario = [], historialVentas = [], carritoManual = [];

        // LOGIN
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('admin-user').value, document.getElementById('admin-pass').value); } 
            catch(e) { document.getElementById('error-msg').classList.remove('d-none'); document.getElementById('error-msg').innerText = "Credenciales incorrectas: " + e.message; }
        });
        window.logout = () => signOut(auth).then(()=>location.reload());

        onAuthStateChanged(auth, (user) => {
            // VERIFICACIÓN DE ADMIN
            if (user && ADMIN_EMAILS.some(email => email.toLowerCase() === user.email.toLowerCase())) {
                document.getElementById('login-screen').classList.add('d-none');
                document.getElementById('dashboard-screen').classList.remove('d-none');
                document.getElementById('admin-name-display').innerText = user.email;
                initApp();
            } else if (user) { 
                alert("Tu correo (" + user.email + ") no tiene permisos de administrador."); 
                signOut(auth); 
            }
        });

        function initApp() {
            // 1. CARGA PRODUCTOS (CON PROTECCIÓN DE ERRORES)
            onSnapshot(collection(db, "productos"), (snap) => {
                try {
                    inventario = [];
                    let valor=0;
                    const tbody = document.getElementById('products-table'); 
                    const selectManual = document.getElementById('manual-product-select');
                    
                    if(tbody) tbody.innerHTML = ''; 
                    if(selectManual) selectManual.innerHTML = '<option value="">Seleccione producto...</option>';

                    snap.forEach(d => {
                        const p = { id: d.id, ...d.data() };
                        inventario.push(p);
                        
                        // Validamos que los datos existan para no romper la tabla
                        const precio = p.precio || 0;
                        const stock = p.stock || 0;
                        const nombre = p.nombre || "Sin Nombre";
                        const cat = p.categoria || "-";

                        valor += (precio * stock);

                        // Llenar tabla
                        if(tbody) {
                            tbody.innerHTML += `
                                <tr class="${stock<5?'table-danger':''}">
                                    <td>
                                        <div class="fw-bold">${nombre}</div>
                                        <small class="text-muted">${p.mejoras||''}</small>
                                    </td>
                                    <td><span class="badge bg-secondary">${cat}</span></td>
                                    <td class="fw-bold">${stock}</td>
                                    <td>${clp.format(precio)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary py-0" onclick="window.editar('${p.id}')"><i class="fas fa-pen"></i></button> 
                                        <button class="btn btn-sm btn-danger py-0" onclick="window.borrar('${p.id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>`;
                        }

                        // Llenar Select Manual
                        if(selectManual && stock > 0) {
                            selectManual.innerHTML += `<option value="${p.id}">${nombre} ($${precio}) - Stock: ${stock}</option>`;
                        }
                    });
                    
                    // SEGURIDAD: Verificar si los elementos existen antes de asignarles valor
                    const kpiEl = document.getElementById('kpi-valor');
                    if(kpiEl) kpiEl.innerText = clp.format(valor);
                    
                    const countEl = document.getElementById('total-items-count');
                    if(countEl) countEl.innerText = inventario.length;

                } catch (error) {
                    console.error("Error al mostrar productos:", error);
                }
            }, (error) => {
                console.error("Error de permisos o conexión:", error);
            });

            // 2. CARGA VENTAS
            onSnapshot(query(collection(db, "ventas"), orderBy("fecha", "desc")), (snap) => {
                historialVentas = [];
                let pagado=0, pendiente=0;
                snap.forEach(d => { 
                    const v={id:d.id, ...d.data()}; 
                    historialVentas.push(v); 
                    if(v.pagado === true) pagado += (v.total||0); else pendiente += (v.total||0);
                });
                
                const kpiPag = document.getElementById('kpi-pagado');
                const kpiPen = document.getElementById('kpi-pendiente');
                if(kpiPag) kpiPag.innerText = clp.format(pagado);
                if(kpiPen) kpiPen.innerText = clp.format(pendiente);
                
                renderVentas(historialVentas);
            });
        }

        // --- CAJA MANUAL ---
        window.agregarAlTicketManual = () => {
            const id = document.getElementById('manual-product-select').value;
            const cant = parseInt(document.getElementById('manual-qty').value);
            if(!id || cant < 1) return alert("Selecciona un producto válido");
            const prod = inventario.find(p => p.id === id);
            const item = carritoManual.find(c => c.id === id);
            if((item?item.cantidad:0) + cant > prod.stock) return alert("No hay suficiente stock");
            if(item) item.cantidad += cant; else carritoManual.push({ id: prod.id, nombre: prod.nombre, precio: prod.precio, cantidad: cant });
            document.getElementById('manual-qty').value = 1; renderTicket();
        };
        window.eliminarItemManual = (i) => { carritoManual.splice(i,1); renderTicket(); };
        function renderTicket() {
            const tbody = document.getElementById('manual-cart-items'); let total=0; tbody.innerHTML='';
            if(!carritoManual.length) tbody.innerHTML='<tr><td colspan="4" class="text-center small">Vacío</td></tr>';
            else carritoManual.forEach((it,i) => { total+=it.cantidad*it.precio; tbody.innerHTML+=`<tr><td>${it.nombre}</td><td class="text-center">${it.cantidad}</td><td class="text-end">${clp.format(it.cantidad*it.precio)}</td><td class="text-end"><button class="btn btn-sm text-danger p-0" onclick="window.eliminarItemManual(${i})"><i class="fas fa-times"></i></button></td></tr>`; });
            document.getElementById('manual-total').innerText = clp.format(total);
        }
        window.confirmarVentaManual = async () => {
            if(!carritoManual.length) return alert("Ticket vacío");
            const cliente = document.getElementById('manual-client-name').value || "Venta Mesón";
            const batch = writeBatch(db); let total=0;
            carritoManual.forEach(i => { batch.update(doc(db, "productos", i.id), { stock: increment(-i.cantidad) }); total+=i.precio*i.cantidad; });
            batch.set(doc(collection(db, "ventas")), { usuario: cliente, email: "manual@admin", detalle: carritoManual, total: total, pagado: document.getElementById('check-pagado').checked, fecha: serverTimestamp() });
            try { await batch.commit(); alert("Venta registrada"); carritoManual=[]; renderTicket(); document.getElementById('manual-client-name').value=""; } catch(e) { alert(e.message); }
        };

        // --- VENTAS ---
        function renderVentas(lista) {
            const tbody = document.getElementById('sales-table'); 
            if(!tbody) return;
            tbody.innerHTML='';
            lista.forEach(v => {
                const f = v.fecha ? v.fecha.toDate().toLocaleDateString() : '-';
                const i = v.detalle ? v.detalle.map(x=>`${x.cantidad}x${x.nombre}`).join(', ') : '';
                const p = v.pagado===true;
                tbody.innerHTML += `<tr><td class="small">${f}</td><td class="fw-bold">${v.usuario}</td><td class="small text-muted">${i}</td><td class="text-end fw-bold">${clp.format(v.total)}</td><td class="text-center"><span class="badge ${p?'bg-success':'bg-danger'}">${p?'Pagado':'Pendiente'}</span></td><td class="text-end"><button class="btn btn-sm ${p?'btn-outline-secondary':'btn-success'} me-1" onclick="window.togglePago('${v.id}', ${p})"><i class="fas ${p?'fa-undo':'fa-check'}"></i></button><button class="btn btn-sm btn-light border me-1" onclick="window.prepEdit('${v.id}')"><i class="fas fa-pen text-warning"></i></button><button class="btn btn-sm btn-light border" onclick="window.borrarVenta('${v.id}')"><i class="fas fa-trash text-danger"></i></button></td></tr>`;
            });
        }
        window.togglePago = async (id, est) => { 
    try { 
        await updateDoc(doc(db, "ventas", id), { pagado: !est }); 
    } catch(e) { alert(e.message); } 
};
        window.borrarVenta = async (id) => { if(!confirm("¿Borrar y devolver stock?")) return; const r=doc(db,"ventas",id); const s=await getDoc(r); if(!s.exists()) return; const d=s.data(); const b=writeBatch(db); if(d.detalle) d.detalle.forEach(i=>b.update(doc(db,"productos",i.id),{stock:increment(i.cantidad)})); b.delete(r); await b.commit(); };

        // --- PRODUCTOS ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = { nombre: document.getElementById('nombre').value, categoria: document.getElementById('categoria').value, mejoras: document.getElementById('mejoras').value, precio: Number(document.getElementById('precio').value), stock: Number(document.getElementById('stock').value), img: document.getElementById('img').value };
            if(id) await updateDoc(doc(db, "productos", id), data); else await addDoc(collection(db, "productos"), data);
            resetForm();
        });
        window.editar = (id) => { const p=inventario.find(x=>x.id===id); document.getElementById('edit-id').value=p.id; document.getElementById('nombre').value=p.nombre; document.getElementById('categoria').value=p.categoria||""; document.getElementById('mejoras').value=p.mejoras||""; document.getElementById('precio').value=p.precio; document.getElementById('stock').value=p.stock; document.getElementById('img').value=p.img; document.getElementById('btn-save').innerText="Actualizar"; document.getElementById('btn-cancel').classList.remove('d-none'); };
        window.resetForm = () => { document.getElementById('product-form').reset(); document.getElementById('edit-id').value=''; document.getElementById('btn-save').innerText="Guardar"; document.getElementById('btn-cancel').classList.add('d-none'); };
        window.borrar = async(id) => { if(confirm("¿Borrar?")) await deleteDoc(doc(db, "productos", id)); };

        // BUSCADOR Y EDIT VENTA
        document.getElementById('search-sales').addEventListener('input', (e) => { const t=e.target.value.toLowerCase(); renderVentas(historialVentas.filter(v=>(v.usuario||"").toLowerCase().includes(t))); });
        window.prepEdit = (id) => { const v=historialVentas.find(x=>x.id===id); document.getElementById('sale-id').value=v.id; document.getElementById('sale-client').value=v.usuario; document.getElementById('sale-total').value=v.total; new bootstrap.Modal(document.getElementById('editSaleModal')).show(); };
        window.guardarVentaEditada = async () => { await updateDoc(doc(db, "ventas", document.getElementById('sale-id').value), { usuario: document.getElementById('sale-client').value, total: Number(document.getElementById('sale-total').value) }); bootstrap.Modal.getInstance(document.getElementById('editSaleModal')).hide(); };
    </script>
</body>
</html>
